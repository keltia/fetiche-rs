# **fetiche-engine**

## Engine

The engine is the main module. It offers a queueing system in which all tasks in the queue are interconnected
in a way that closely resemble a UNIX pipe. You typically have a producer, one or more filters and a
consumer at the end. Producers will generate or fetch data from a specific source and consumers are often
used for storing the data in different ways.

## Design

The Engine is all about actors now.

Upon startup and after loading the configuration, `Engine::new()` launches several common actors:

- *engine::sources* will load `$BASEDIR/sources.hcl` and returns a `Site` when asked
- *engine::state* will load `$BASEDIR/state` which will retrieve the last Job ID used, then will set up its own 30s sync
  timer.
- *engine::queue* will create the new in-memory empty job queue but will use the last Job ID as "next" so we don't step
  on another job's data, even if it were interrupted.

## Sources

This is the crate implementing the site-specific ways of accessing, authenticating and fetching data from the
supported sources. Currently, we support:

- Aeroscope (deprecated)
- ASD
- Opensky
- Avionix Cube
- Avionix Server
- Thales Senhive
- Flightaware ADS-B flows
- Safesky (incomplete)

A source can support one or more operation like `Fetch` and `Stream`. At this moment, We have several sources for
streaming (Opensky, Senhive and Avionix). The different supported sources are enabled through Cargo features.

### Aeroscope (feature `aeroscope`)

This is the data extracted from a local Aeroscope antenna, considering you are supposed to have a local server attached
to the antenna. Software supplied by DJI store data in its [MongoDB] database and there is a local API to access said
data. Our antenna was supplied by [ASD] and interestingly enough the data model and access methods are not exactly the
same. This source is for the moment deprecated.

### ASD (feature `asd`)

This source is for data aggregated by [ASD] on the `airspacedrones.com` through their own API. The data model & API are
different from the local access in the previous one because you can have multiple antennas from a single API endpoint.

### Avionix Cube (feature `avionix`)

Avionix has developed a drone surveillance system with their own antenna, supporting only [RemoteID] as wire protocol.  
Many DJI drones already implement RemoteID so it will be interesting to see how different the traffic is when using
Remote ID information only. The data feed is accessible through a server-based API or directly from the antenna. The
former has either poll-based calls or a TCP streaming fee, whereas the antenna only has TCP streaming.

Avionix Cube sends both ADS-B and RemoteID data.

### Thales Senhive (feature `senhive`)

Thales has its own drone surveillance system as well, called Senhive. This is yet another way to fetch the data, as
they are using [AMQP] and its topic-based architecture. We will be using [Lapin] as our main AMQP client library, see
[this example](../engine/examples/senhive-amqp.rs) for details.

### Opensky (feature `opensky`)

Opensky is different from the previous two sources as it is an ADS-B data site, not a drone-specific one. We use Opensky
for sites that do not have access to our own set of ADS-B antennas (called EMIT). The API is radically different from
more common sources like Flightradar24 or Flightaware. You have access to only the last hour of data through the API and
you must use their SSH-based Impala shell for "historical" datasets.

I am currently cheating there by repeatedly calling the API (there are no API limitation for data generated by you own
antennas) and generating a stream from this. I have included a caching system to avoid sending the data several times
as the API can (and will) send you the same dataset sometimes.

### Safesky (feature `safesky`)

Safesky is an alternate ADS-B source we thought we'd be working with at some point so partial support is there but has
not been tested. See the [source](../engine/src/sources/access/safesky.rs).

### Flightaware (feature `flightaware`)

Flightaware Hose ADS-B data feed is now supported as well, although we do not have an account for now.

## Configuration

I use an [HCL] file called `sources.hcl`  to store the source parameters. You are not really supposed to edit this and
that's why it is not documented in `acutectl`. It also contains the credentials for the various access points.

On UNIX systems, it is located in `$HOME/.config/drone-utils/sources.hcl` and in `%LOCALAPPDATA%\DRONE-UTILS` on
Windows.

The current config file version is 4. This is where all the URL for the parts of each API are defined, which routes are
available, the default data model etc.

<details>
<summary>sources.hcl</summary>

```hcl
version = 4

site "local" {
  features = ["fetch"]
  type     = "drone"
  format   = "aeroscope"
  base_url = "http://127.0.0.1:2400"
  routes = {
    get = "/drone/get"
  }
}

site "big.site.aero" {
  features = ["fetch"]
  type     = "drone"
  format   = "asd"
  base_url = "https://api.site.aero"
  routes = {
    get = "/api/journeys/filteredlocations/json"
  }
}

site "opensky" {
  features = ["fetch", "stream"]
  type     = "adsb"
  format   = "opensky"
  base_url = "https://opensky-network.org/api"
  routes = {
    get = "/states/own"
  }
}

site "safesky" {
  features = ["fetch"]
  type     = "adsb"
  format   = "safesky"
  base_url = "https://public-api.safesky.app"
  routes = {
    get = "/v1/beacons"
  }
}
```

</details>

## Runners

The *engine::runner* actor will be used for the *RunnerFactory* as a template. Right now, we have only one running
job because we run in the scope of `acutectl`. When we switch back to a daemon-based `fetiched`, this will be different.

## Jobs

A job has an ID and a list of tasks which will be each executed by a different thread and all thread in
the pipe will be connected through channels. The Nth task's output will be a `Sender`  connected to the
`Receiver` on the next task.

## Tasks

Each task is defined with a struct which has the `Runnable Derive` derive pragma defined. This corresponds
to a proc-macro that will generate two methods in the trait: `cap()` to get the type of task (used in the
job runner to check that the pipe is valid)  and `run()`  which is the main thread executing the job.

For this, each task MUST define an `execute()`  method that will be called for each packet received
by the `run()` thread.

The current tasks defined are:

- `Nothing`
- `Message`
- `Copy`
- `Convert`
- `Fetch`
- `Read`
- `Save`
- `Store`
- `S3store`
- `Stream`

I think it is more flexible to work within the framework of the engine.

## Producers

Producers are typically at the start of a job queue. They get or generate data in specific ways and send
them down the pipe. Best examples are `Fetch`  and `Stream`.

### Fetch

This used some API to fetch a file or chunk of data and send it down.

### Stream

This is used for streaming APIs, whether native like Flightaware or simulated ones (like we do with Opensky).

### Read

This is the same as `Fetch` but for a local file (think: reading a CSV file).

## Filters

Filters are only allowed between producers and consumers. Typically, you will use `Convert` when you need
to convert the upstream data into a different format and send it down the pipeline.

### Nothing, Message and Copy

These are there more to test and implement simple functions.

### Convert

At the moment, this task only supports converting into our own `DronePoint` format, usually as CSV. This is a way
to unify all drone data coming from different providers.

## Consumers

Consumers are used to store or duplicate data into different storage methods or even send data through
different means (imagine a Multicast task).

### Save

This task saves the data it received into a single file.

### Store

This task get all data from the upstream pipe and store it into a specific directory organized by Job ID
and using a different file for every hour.

### S3store (NOT IMPLEMENTED)

This is like the previous `Store`  but using an S3-compatible method.


[AMQP]: https://en.wikipedia.org/wiki/Advanced_Message_Queuing_Protocol

[ASD]: https://eur.airspacedrone.com/

[Actix]: https://actix.rs/

[ASTERIX]: https://www.eurocontrol.int/asterix/

[Lapin]: https://crates.io/crates/lapin

[Opensky]: https://www.opensky-network.org/

[Parquet]: https://parquet.apache.org/

[RabbitMQ]: https://en.wikipedia.org/wiki/RabbitMQ

[RemoteID]: https://en.wikipedia.org/wiki/Remote_ID

[RUST]: https://www.rust-lang.org/

[Safesky]: https://safesky.app/

[HCL]: https://developer.hashicorp.com/terraform/language

[GitHub issues]: https://github.com/keltia/fetiche-rs/issues

[Actix]: https://actix.rs/

